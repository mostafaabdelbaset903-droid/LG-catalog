<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ุซูุงุฌุงุช LG</title>
<link rel="stylesheet" href="soft-ui.css">
</head>
<body>

<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">ุซูุงุฌุงุช LG</div>
        <div class="subtitle">ุงุฎุชุฑ ุงูููุฏููุงุช โ ุฃุถู ููุณูุฉ โ ุฃุฑุณู ูุงุชุณุงุจ</div>

        <div class="nav">
          <a href="index.html">ุงูุฑุฆูุณูุฉ</a>
          <a href="ac.html">ุชููููุงุช</a>
          <a href="washers.html">ุบุณุงูุงุช</a>
          <a class="active" href="fridges.html">ุซูุงุฌุงุช</a>
          <a href="builtin.html">Built-in</a>
          <a href="view.html">ุนุฑุถ ุงูุนููู</a>
        </div>
      </div>

      <button class="btn btnGhost" id="btnClear">ูุณุญ ุงูุณูุฉ</button>
    </div>
  </div>
</header>

<div class="wrap layout">
  <main id="content"></main>

  <aside class="cartBar">
    <div class="cartHeader">
      <div>
        <div class="cartTitle">ุงูุณูุฉ</div>
        <div class="small" id="cartCount">0 ููุฏูู</div>
      </div>
      <button class="btn btnGhost" id="btnToggle">ุฅุธูุงุฑ/ุฅุฎูุงุก</button>
    </div>

    <div id="cartBody">

      <div class="cartItems" id="cartItems">
        <div class="small">ูุณู ูููุด ุงุฎุชูุงุฑุงุช.</div>
      </div>

      <!-- ุฑูู ุงูุนููู -->
      <div class="row">
        <div style="width:100%">
          <div class="small" style="margin:8px 0 6px;">
            ุฑูู ูุงุชุณุงุจ ุงูุนููู
          </div>
          <input id="phone" placeholder="2010xxxxxxx"/>
        </div>
      </div>

      <!-- ุงุณู ุงูููุธู -->
      <div class="row">
        <div style="width:100%">
          <div class="small" style="margin:8px 0 6px;">
            ุงุณู ุงูููุธู
          </div>
          <input id="employee" placeholder="ุงูุชุจ ุงุณูู"/>
        </div>
      </div>

      <div class="row">
        <button class="btn btnGhost" id="btnLink">ุฅูุดุงุก ูููู</button>
        <button class="btn btnPrimary" id="btnWhats">ุฅุฑุณุงู ูุงุชุณุงุจ</button>
      </div>

      <div class="small" style="margin-top:10px;">
        ูููู ุงูุนููู:
        <span id="linkOut">โ</span>
      </div>

    </div>
  </aside>
</div>

<div class="wrap spacer"></div>

<script src="products.js"></script>

<script>

const CART_KEY = "lg_cart_v1";
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztaAJhbUhjC9o4ZDSwatwdjXPKsTeA4yEQkDTDVjPXQ2aB24KlABNZFYiLOd2D8E5J/exec";

function loadCart(){
  return JSON.parse(localStorage.getItem(CART_KEY) || "[]");
}

function saveCart(data){
  localStorage.setItem(CART_KEY, JSON.stringify(data));
}

const ALL = window.PRODUCTS || [];
const contentEl = document.getElementById("content");
const cartItemsEl = document.getElementById("cartItems");
const cartCountEl = document.getElementById("cartCount");
const linkOutEl = document.getElementById("linkOut");
const phoneInput = document.getElementById("phone");
const employeeInput = document.getElementById("employee");

let cart = loadCart();
let cartVisible = true;

/* ุนุฑุถ ุงูุซูุงุฌุงุช */
function renderProducts(){

  contentEl.innerHTML = "";
  const fridges = ALL.filter(p => p.section === "fridge");

  if(fridges.length === 0){
    contentEl.innerHTML = "<div class='small'>ูุง ุชูุฌุฏ ุซูุงุฌุงุช</div>";
    return;
  }

  const grid = document.createElement("div");
  grid.className = "grid";

  fridges.forEach(p=>{
    const card = document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <div class="cardMedia">
        <img src="${p.img || ""}" alt="">
      </div>
      <div class="p">
        <div class="name">${p.name || p.model || "โ"}</div>
        <ul>
          ${(p.features||[]).slice(0,5).map(f=>`<li>${f}</li>`).join("")}
        </ul>
        ${
          p.dims ? `
          <div class="dimsBox">
            <div>${p.dims.w} ร ${p.dims.d} ร ${p.dims.h}</div>
          </div>
          ` : ""
        }
        <button class="btn btnAdd">ุฃุถู ููุณูุฉ</button>
      </div>
    `;

    card.querySelector(".btnAdd").onclick=()=>addToCart(p.id);
    grid.appendChild(card);
  });

  contentEl.appendChild(grid);
}

/* ุงูุณูุฉ */
function addToCart(id){
  if(!cart.includes(id)){
    cart.push(id);
    saveCart(cart);
    renderCart();
  }
}

function removeFromCart(id){
  cart = cart.filter(x=>x!==id);
  saveCart(cart);
  renderCart();
}
window.removeFromCart = removeFromCart;

function renderCart(){

  const items = cart.map(id=>ALL.find(p=>p.id===id)).filter(Boolean);
  cartCountEl.textContent = items.length + " ููุฏูู";

  if(items.length===0){
    cartItemsEl.innerHTML="<div class='small'>ูุณู ูููุด ุงุฎุชูุงุฑุงุช.</div>";
    return;
  }

  cartItemsEl.innerHTML = items.map(p=>`
    <div class="cartItem">
      <div>${p.name || p.model || p.id}</div>
      <button class="btn btnGhost"
        onclick="removeFromCart('${p.id}')">ุญุฐู</button>
    </div>
  `).join("");
}

/* ุฅูุดุงุก ูููู */
function buildLink(){

  const items = cart.map(id=>ALL.find(p=>p.id===id)).filter(Boolean);
  if(items.length===0) return "";

  const encoded = encodeURIComponent(
    btoa(unescape(encodeURIComponent(JSON.stringify(items))))
  );

  const base = location.href.replace("fridges.html","");
  return base + "view.html?c=" + encoded;
}

document.getElementById("btnLink").onclick=()=>{
  const link = buildLink();
  linkOutEl.innerHTML = link ? `<a href="${link}" target="_blank">ูุชุญ</a>` : "โ";
};

document.getElementById("btnWhats").onclick=()=>{

  const phone = phoneInput.value.trim();
  const employee = employeeInput.value.trim();

  if(!phone) return alert("ุงูุชุจ ุฑูู ุงูุนููู");
  if(!employee) return alert("ุงูุชุจ ุงุณู ุงูููุธู");

  const link = buildLink();
  if(!link) return alert("ุงูุณูุฉ ูุงุถูุฉ");

  const items = cart.map(id=>ALL.find(p=>p.id===id)).filter(Boolean);
  const list = items.map((p,i)=>`${i+1}) ${p.name || p.model || p.id}`).join("\n");

  const msg = `
ุฃููุงู ุจุญุถุฑุชู ๐
ุฏู ุงูููุฏููุงุช ุงููุฎุชุงุฑุฉ:
${list}

ุชูุงุตูู ูุงููุฉ:
${link}

ุชู ุงูุฅุฑุณุงู ุจูุงุณุทุฉ: ${employee}
`.trim();

  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,"_blank");

  fetch(GOOGLE_SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      employee:employee,
      clientPhone:phone,
      products:list,
      link:link,
      date:new Date().toLocaleString()
    })
  });

};

document.getElementById("btnClear").onclick=()=>{
  cart=[];
  saveCart(cart);
  renderCart();
};

document.getElementById("btnToggle").onclick=()=>{
  cartVisible=!cartVisible;
  document.getElementById("cartBody").style.display=
    cartVisible?"block":"none";
};

window.addEventListener("storage",()=>{
  cart=loadCart();
  renderCart();
});

renderProducts();
renderCart();

</script>
</body>

</html>
